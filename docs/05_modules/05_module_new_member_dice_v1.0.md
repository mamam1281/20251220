# 신규회원 전용 주사위 게임(판정용) — 기술/디자인 문서

- 문서 타입: 기능(프론트 + 백엔드 + 운영)
- 버전: v1.1
- 작성일: 2025-12-16
- 대상: 운영/백엔드/프론트

## 0. 목적 요약(요구사항 재정의)
신규회원 대상으로 **별도의 전용 주사위 게임 페이지**를 제공한다.
- 메인(홈)에서 링크로 노출하지 않아도 됨(직접 URL/문자 링크로 진입).
- 로그인은 기존 시스템(RequireAuth/기존 세션)을 그대로 사용.
- 기존 주사위의 “굴림 애니메이션” UI는 그대로 재사용.
- 규칙: 유저 vs 딜러가 **주사위 1개씩** 굴려 **높은 수가 이김**.
- 승률: **딜러 95% 승 / 유저 5% 승**(즉, 유저 패배율 95%).
- 보상은 시스템적으로 지급하지 않음.
- 결과 문구(최소 요구):
  - 승리 시: “선착순 이벤트 당첨”
  - 패배 시: “다음기회에, 다른 이벤혜택은 지민이 문의”
- 운영 흐름(캠페인 맥락):
  1) 문자 발송(선착순)
  2) “확정 아님, 판정 필요” 안내
  3) 주사위 게임 1회(무료/입금 아님)
  4) 승/패(유저 패배율 95%)
  5) 승/패별 출구 멘트 + 이벤트 연결

## 1. 결론: 이해한 목적
- 이 기능은 기존 ‘주사위 배틀(토큰 소비/보상 지급)’이 아니라,
  **신규회원 대상 프로모션에서 “판정”을 위해 1회 굴리고 결과를 안내하는 별도 페이지**다.
- “확정 아님, 판정 필요”라는 문구는 **선착순 캠페인 특성상 자동 확정이 아니라 운영 확인/후속 안내가 필요**함을 사용자에게 고지하는 목적이다.

## 2. 관리자 티켓 부여가 필요한가?
현재 기존 주사위 게임은 백엔드에서 `DICE_TOKEN`을 **필수로 소모**한다(티켓/토큰 없으면 플레이 불가).

따라서 선택지는 2개다:

### 옵션 A(비추천): 기존 주사위 API 재사용
- 장점: 새 백엔드 개발 최소화
- 단점:
  - 플레이마다 `DICE_TOKEN`을 강제 소모하므로 **운영자가 신규회원에게 주사위 티켓을 반드시 지급**해야 함.
  - 기존 Dice는 feature schedule/활성화 조건, 보상 지급/로그/시즌패스 등 기존 정책이 섞여 들어갈 수 있음.
  - 승률(유저 5%)와 “주사위 1개” 규칙도 기존 구조(현재 2개 합산)와 불일치.

### 옵션 B(추천): 신규회원 전용 “판정” API/로그를 별도로 만든다
- 장점:
  - **무료 1회**를 서버에서 강제(티켓 지급 없이 진행 가능)
  - 유저 5% 승률, 주사위 1개 규칙을 정확히 구현
  - 운영 추적/감사 로그(누가 언제 했는지)를 남겨 선착순/판정 이슈 대응 가능
- 결론(추천): **관리자 티켓 지급을 없애고**, 신규 전용 엔드포인트로 처리

> 정리: “티켓”을 의미가 ‘기존 게임 토큰’이라면, 옵션 A에서는 필요하고 옵션 B에서는 불필요하다.
> 운영 관점에서는 옵션 B가 훨씬 안전/간단하다.

## 3. UX/디자인 스펙(밝은 크리스마스 톤)
### 3.1 페이지 성격
- 기존 다크톤 게임 페이지 대비 **더 밝고** “크리스마스 느낌”을 강화
- 단, 기존 디자인 시스템(현재 Tailwind 기반 토큰/클래스) 범위 내에서 구현

### 3.2 화면 구성(최소)
1) 상단 안내 배너
- 타이틀 예: “신규회원 이벤트 판정”
- 안내(필수 의미): “확정 아님 · 판정 필요” / “무료 1회”

2) 가운데 주사위 영역
- 기존 애니메이션 컴포넌트 재사용
- 좌: “유저”, 우: “딜러”
- 각 1개 주사위

3) CTA 버튼
- 상태:
  - 기본: “🎲 판정 시작(1회)”
  - 진행중: “굴리는 중...” (버튼 disabled)

4) 결과 영역
- WIN: “선착순 이벤트 당첨”
- WIN CTA: 링크 버튼 “이벤트 확인하기” → https://ccc-010.com
- LOSE: “다음기회에, 다른 이벤혜택은 지민이 문의”
- (선택) 하단에 “운영 확인 후 안내됩니다” 같은 보조 문구는 가능하나, 최소 요구는 위 2문구가 핵심

### 3.3 페이지 접근(메인 연결 없음)
- 라우트만 등록하고 홈/메인 카드에서는 링크를 만들지 않는다.
- 예시 경로: `/new-member/dice`

## 4. 기능 요구사항(프론트)
- 로그인 가드: 기존 `RequireAuth`를 그대로 사용(미로그인 시 로그인 페이지로)
- 자격(eligible) 판정: 서버 응답 기준(운영자 등록된 유저만 진입/플레이 허용)
- 1회 제한:
  - 서버에서 “이미 플레이함”을 반환하면 버튼 비활성 + 결과 재표시
- 상태:
  - `isRolling` (애니메이션/로딩)
  - `userRoll`, `dealerRoll`
  - `outcome` (WIN/LOSE)
  - `message` (출구 멘트)
  - `winLink` (WIN일 때만 표시, https://ccc-010.com)

## 5. 기능 요구사항(백엔드, 옵션 B 기준)
### 5.1 API 설계
- `GET /api/new-member-dice/status`
  - 응답: `eligible`, `already_played`, `played_at?`, `last_outcome?`, `win_link?`
- `POST /api/new-member-dice/play`
  - 서버가 주사위 결과 생성 및 저장 후 반환
  - 응답 예:
    ```json
    {
      "result": "OK",
      "game": {
        "user_dice": [2],
        "dealer_dice": [6],
        "outcome": "LOSE"
      },
      "message": "다음기회에, 다른 이벤혜택은 지민이 문의",
      "win_link": "https://ccc-010.com"
    }
    ```

#### 5.1.1 자격(eligible) 판정 규칙 — 운영자 등록 방식(확정)
- 원칙: **운영자가 등록한 대상자만** 이 페이지에서 플레이 가능
- 구현: `eligible`은 아래 “대상자 등록 테이블”에 현재 user_id(+campaign_key)가 존재하는지로 판정
- 기대 UX:
  - `eligible=false`이면: 페이지는 열리더라도 플레이 버튼 비활성 + 안내 문구(예: “대상자 확인이 필요합니다. 지민이에게 문의해주세요.”)
  - `eligible=true`이면: 정상 진행

### 5.2 승률/주사위 생성 규칙(유저 승 5%)
- 서버에서 outcome을 먼저 결정:
  - `r < 0.05` → 유저 WIN
  - 그 외 → 딜러 WIN
- 동점은 허용하지 않음(요구가 “높은 수가 이기는” 구조이므로).
- 예시 생성 로직(간단/일관성):
  - WIN일 때: `dealer = randint(1..5)`, `user = randint(dealer+1..6)`
  - LOSE일 때: `user = randint(1..5)`, `dealer = randint(user+1..6)`

### 5.3 1회 제한(무료 1회)
- `user_id` 기준으로 1회만 허용(캠페인이 여러 개면 `campaign_id`까지 포함)
- `POST`가 재호출되면:
  - 기존 결과 재반환(멱등) 또는 에러(409)

### 5.4 데이터 저장(감사/운영 대응)
권장 신규 테이블: `new_member_dice_log`
- `id`
- `user_id` (FK 권장)
- `campaign_key`(nullable, 문자열)
- `user_roll` / `dealer_roll`
- `outcome` (WIN/LOSE)
- `created_at`
- (선택) `ip`, `user_agent` (부정 사용/분쟁 대응)

> 기존 `dice_log`를 재사용하지 않는 이유: 토큰/보상/기존 정책과 분리해 운영 리스크를 낮추기 위함.

#### 5.4.1 대상자(eligible) 등록 테이블(권장)
권장 신규 테이블: `new_member_dice_eligibility`
- `id`
- `user_id` (FK 권장, unique)
- `campaign_key`(nullable, 문자열. 캠페인별로 여러 번 진행 가능성을 대비하면 unique(user_id, campaign_key))
- `created_by_admin_user_id`(nullable)
- `created_at`
- (선택) `expires_at`

운영 프로세스:
- 운영자가 신규회원 대상자 선정 후 eligibility에 등록
- 문자를 통해 `/new-member/dice` 링크 배포

### 5.5 “선착순”과 “확정 아님”의 기술적 처리
- 이 페이지는 기본적으로 “판정 결과 표시”까지 제공.
- 선착순 확정/문자 발송/혜택 지급은 별도 운영 프로세스일 수 있으므로:
  - 기본은 `WIN`이더라도 “확정 아님(판정 필요)” 고지를 유지
  - 필요 시 추후 확장:
    - 남은 당첨 수량(quota) 체크
    - `WIN`일 때만 `PENDING_REVIEW` 상태로 적재 → 운영자가 확정 처리

## 6. 운영 시나리오(권장)
- 운영자가 문자에 `/new-member/dice` 링크 제공
- 사용자는 로그인 후 페이지에서 1회 플레이
- 운영자는 백오피스/DB 로그에서 WIN 사용자만 추출해 “선착순 당첨 확정” 처리

## 7. 보안/악용 방지(최소)
- 결과는 클라이언트 랜덤이 아닌 **서버에서 생성**
- 1회 제한은 DB로 강제
- 요청 빈도 제한(간단히는 라우터 레벨 throttling 또는 WAF)

## 8. 구현 체크리스트(개발)
- 프론트
  - 신규 페이지 컴포넌트 생성
  - 기존 주사위 애니메이션 컴포넌트 재사용(주사위 1개 모드)
  - 신규 API 훅/클라이언트 추가
  - 라우트만 등록(메인 링크 없음)
- 백엔드
  - 신규 모델/마이그레이션
  - 신규 라우터 + 서비스
  - 테스트(1회 제한, 5% 승률은 통계 테스트 대신 결과 생성 규칙 단위 테스트)

## 9. 오픈 질문(결정 필요)
1) “신규회원” 자격은 어떻게 판정할까?
- 결정: C) 운영자가 대상자만 “eligible”로 등록

2) 승리(WIN) 시 “이벤트 연결”은 어디로?
- 결정: https://ccc-010.com

3) 결과 문구는 정확히 고정 문구인가, 약간의 보조 문구를 허용하는가?
- 최소 요구는 고정 2문구만 준수
